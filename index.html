<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدير حملات السوشال ميديا</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Sheet.js (xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts: Tajawal for Arabic, Inter for English -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* A better-looking scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.6);
        }

        body {
            font-family: 'Tajawal', 'Inter', sans-serif;
            background-color: #0f172a; /* Dark slate blue fallback */
        }
        
        /* Updated Glassmorphism class for better contrast */
        .glass-card {
            background: rgba(15, 23, 42, 0.6); /* Darker, more opaque slate blue */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        /* Chart.js Global Font Settings */
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 bg-cover bg-center bg-fixed" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?auto=format&fit=crop&q=80&w=2071');">
    <div id="root"></div>

    <script>
        // No JSX, so we're using vanilla React.createElement
        const e = React.createElement;
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Database Helper ---
        const DB_NAME = 'SocialMediaCampaignsDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'campaigns';

        const db = {
            instance: null,
            async init() {
                return new Promise((resolve, reject) => {
                    if (this.instance) {
                        resolve(this.instance);
                        return;
                    }

                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = (event) => {
                        console.error("Database error:", event.target.error);
                        reject("Database error");
                    };

                    request.onupgradeneeded = (event) => {
                        const dbInstance = event.target.result;
                        if (!dbInstance.objectStoreNames.contains(STORE_NAME)) {
                            dbInstance.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        }
                    };

                    request.onsuccess = (event) => {
                        this.instance = event.target.result;
                        resolve(this.instance);
                    };
                });
            },
            async exec(method, storeName, ...args) {
                const dbInstance = await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(storeName, method === 'get' || method === 'getAll' ? 'readonly' : 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store[method](...args);
                    
                    transaction.oncomplete = () => resolve(request.result);
                    transaction.onerror = (event) => {
                        console.error(`Transaction error on ${method}:`, event.target.error);
                        reject(event.target.error);
                    }
                });
            }
        };

        // --- Main App Component ---
        const App = () => {
            const [campaigns, setCampaigns] = useState([]);
            const [screen, setScreen] = useState('dashboard'); // dashboard, edit, add, details
            const [currentItem, setCurrentItem] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [viewMode, setViewMode] = useState('table'); // table, kanban
            const [incognitoWarning, setIncognitoWarning] = useState(false);
            
            const navigate = (screen, item = null) => {
                setCurrentItem(item);
                setScreen(screen);
            };

            const loadCampaigns = useCallback(async () => {
                setIsLoading(true);
                setError(null);
                try {
                    const data = await db.exec('getAll', STORE_NAME);
                    setCampaigns(data || []);
                } catch (err) {
                    console.error("Failed to load campaigns:", err);
                    setError('فشل في تحميل الحملات. يرجى تحديث الصفحة.');
                } finally {
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                loadCampaigns();
                try {
                    navigator.storage.estimate().then(estimate => {
                        if (estimate.quota < 120000000) {
                           setIncognitoWarning(true);
                        }
                    });
                } catch (e) {
                     setIncognitoWarning(true);
                }
                
                const handleBeforeUnload = (e) => {
                    e.preventDefault();
                    e.returnValue = 'هل أنت متأكد من رغبتك في المغادرة؟ قد يتم فقدان البيانات غير المحفوظة.';
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);

            }, [loadCampaigns]);

            const handleSave = async (campaignData) => {
                setIsLoading(true);
                try {
                    if (campaignData.id) {
                        await db.exec('put', STORE_NAME, campaignData);
                    } else {
                        const newCampaign = { ...campaignData, createdAt: new Date().toISOString() };
                        delete newCampaign.id;
                        await db.exec('add', STORE_NAME, newCampaign);
                    }
                    await loadCampaigns();
                    navigate('dashboard');
                } catch (err) {
                    console.error("Save error:", err);
                    setError("فشل في حفظ الحملة.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleDelete = async (id) => {
                // A custom confirmation modal would be better than window.confirm
                if (window.confirm('هل أنت متأكد من حذف هذه الحملة؟ لا يمكن التراجع عن هذا الإجراء.')) {
                    setIsLoading(true);
                    try {
                        await db.exec('delete', STORE_NAME, id);
                        await loadCampaigns();
                        navigate('dashboard');
                    } catch (err) {
                        console.error("Delete error:", err);
                        setError("فشل في حذف الحملة.");
                    } finally {
                        setIsLoading(false);
                    }
                }
            };

            const handleDuplicate = async (campaign) => {
                 const newCampaign = { ...campaign };
                 delete newCampaign.id;
                 newCampaign.name = `${campaign.name} (نسخة)`;
                 await handleSave(newCampaign);
            }

            const renderScreen = () => {
                switch (screen) {
                    case 'add':
                        return e(CampaignForm, { onSave: handleSave, onCancel: () => navigate('dashboard') });
                    case 'edit':
                        return e(CampaignForm, { campaign: currentItem, onSave: handleSave, onCancel: () => navigate('dashboard'), onDelete: handleDelete });
                    case 'details':
                        return e(CampaignDetails, { campaign: currentItem, onBack: () => navigate('dashboard'), onEdit: () => navigate('edit', currentItem), onDelete: handleDelete });
                    default:
                        return e(Dashboard, { campaigns, navigate, viewMode, setViewMode, loadCampaigns, handleDuplicate });
                }
            };

            return e('div', { className: 'min-h-screen p-4 sm:p-6 lg:p-8' },
                e('div', { className: 'glass-card p-6 max-w-7xl mx-auto' },
                    e(Header, { campaigns, loadCampaigns }),
                    incognitoWarning && e(Alert, { message: 'تحذير: أنت في وضع التصفح المتخفي. سيتم حذف جميع بياناتك عند إغلاق المتصفح.', type: 'warning' }),
                    error && e(Alert, { message: error, type: 'error' }),
                    isLoading ? e(LoadingSpinner) : renderScreen()
                )
            );
        };
        
        // --- Child Components ---
        const Header = ({ campaigns, loadCampaigns }) => {
            const handleExportJson = () => {
                const dataStr = JSON.stringify(campaigns, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = 'campaigns_backup.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const handleImportJson = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if(Array.isArray(importedData) && window.confirm("هل أنت متأكد؟ سيؤدي هذا إلى الكتابة فوق جميع البيانات الحالية.")) {
                            await db.exec('clear', STORE_NAME);
                            for (const item of importedData) {
                                delete item.id;
                                await db.exec('add', STORE_NAME, item);
                            }
                            await loadCampaigns();
                            alert("تم استيراد البيانات بنجاح!");
                        } else {
                            throw new Error("ملف غير صالح");
                        }
                    } catch (err) {
                        alert("فشل استيراد الملف. تأكد من أنه ملف JSON صالح.");
                        console.error("Import error:", err);
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // Reset input
            };

            const handleClearAll = async () => {
                if (prompt("لحذف جميع البيانات، اكتب 'حذف' في المربع أدناه.") === "حذف") {
                    await db.exec('clear', STORE_NAME);
                    await loadCampaigns();
                    alert("تم حذف جميع البيانات.");
                }
            };
            
            const handlePrint = () => window.print();

            return e('div', { className: 'flex flex-col sm:flex-row justify-between items-center mb-6 no-print' },
                e('h1', { className: 'text-2xl sm:text-3xl font-bold text-white mb-4 sm:mb-0' }, 'لوحة تحكم الحملات'),
                e('div', { className: 'flex flex-wrap gap-2' },
                    e('label', { className: 'cursor-pointer bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors' },
                        'استيراد JSON',
                        e('input', { type: 'file', accept: '.json', className: 'hidden', onChange: handleImportJson })
                    ),
                    e('button', { onClick: handleExportJson, className: 'bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors' }, 'تصدير JSON'),
                    e('button', { onClick: handlePrint, className: 'bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors' }, 'طباعة'),
                    e('button', { onClick: handleClearAll, className: 'bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition-colors' }, 'حذف الكل')
                )
            );
        };
        
        const Dashboard = ({ campaigns, navigate, viewMode, setViewMode, handleDuplicate }) => {
            const handleExportXlsx = () => {
                const ws = XLSX.utils.json_to_sheet(campaigns);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Campaigns");
                XLSX.writeFile(wb, "campaigns.xlsx");
            };
            
            return e('div', { className: 'printable-area' },
                e(KPIs, { campaigns }),
                e('div', { className: 'flex justify-between items-center my-6 no-print' },
                    e('div', { className: 'flex gap-1 p-1 bg-slate-700/50 rounded-lg' },
                        e('button', { onClick: () => setViewMode('table'), className: `px-4 py-2 rounded-md transition text-sm font-medium ${viewMode === 'table' ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-slate-600/50'}` }, 'عرض جدول'),
                        e('button', { onClick: () => setViewMode('kanban'), className: `px-4 py-2 rounded-md transition text-sm font-medium ${viewMode === 'kanban' ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-slate-600/50'}` }, 'عرض كانبان')
                    ),
                    e('div', {className: 'flex gap-2'},
                       e('button', { onClick: handleExportXlsx, className: 'bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors' }, 'تصدير Excel'),
                       e('button', { onClick: () => navigate('add'), className: 'bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors' }, 'إضافة حملة جديدة')
                    )
                ),
                viewMode === 'table' 
                    ? e(CampaignTable, { campaigns, navigate, handleDuplicate })
                    : e(KanbanBoard, { campaigns, navigate, handleDuplicate })
            );
        };
        
        const KPIs = ({ campaigns }) => {
            const chartRef = useRef(null);
            const pieChartRef = useRef(null);

            useEffect(() => {
                if (!campaigns.length) return;

                const budgetData = {
                    labels: campaigns.map(c => c.name),
                    datasets: [
                        {
                            label: 'الميزانية',
                            data: campaigns.map(c => c.budget || 0),
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'المصروف الفعلي',
                            data: campaigns.map(c => c.spent || 0),
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                };

                const statusCounts = campaigns.reduce((acc, c) => {
                    acc[c.status] = (acc[c.status] || 0) + 1;
                    return acc;
                }, {});

                const statusData = {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['rgba(251, 191, 36, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(139, 92, 246, 0.7)'],
                        borderColor: '#0f172a',
                    }]
                };

                const budgetCtx = chartRef.current?.getContext('2d');
                const pieCtx = pieChartRef.current?.getContext('2d');
                let budgetChart, pieChart;
                if (budgetCtx) {
                     budgetChart = new Chart(budgetCtx, { type: 'bar', data: budgetData, options: { scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { grid: { color: 'rgba(255, 255, 255, 0.1)' } } }, plugins: { legend: { labels: { color: '#9ca3af' } } } } });
                }
                if (pieCtx) {
                     pieChart = new Chart(pieCtx, { type: 'pie', data: statusData, options: { plugins: { legend: { position: 'top', labels: { color: '#9ca3af' } } } } });
                }
                
                return () => {
                    budgetChart?.destroy();
                    pieChart?.destroy();
                };
            }, [campaigns]);

            const totalBudget = campaigns.reduce((sum, c) => sum + (Number(c.budget) || 0), 0);
            const totalSpent = campaigns.reduce((sum, c) => sum + (Number(c.spent) || 0), 0);
            
            return e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8' },
                e(StatCard, { title: 'إجمالي الحملات', value: campaigns.length }),
                e(StatCard, { title: 'إجمالي الميزانية', value: `${totalBudget.toLocaleString()} $` }),
                e(StatCard, { title: 'إجمالي المصروف', value: `${totalSpent.toLocaleString()} $` }),
                e(StatCard, { title: 'الحملات النشطة', value: campaigns.filter(c => c.status === 'نشطة').length }),
                e('div', { className: 'md:col-span-2 lg:col-span-2 glass-card p-4' }, e('canvas', { ref: chartRef })),
                e('div', { className: 'md:col-span-2 lg:col-span-2 glass-card p-4 flex justify-center items-center' }, e('div', { className: 'w-full max-w-[300px]' }, e('canvas', { ref: pieChartRef })))
            );
        };
        
        const StatCard = ({ title, value }) => {
            return e('div', { className: 'glass-card p-4 text-center' },
                e('h3', { className: 'text-gray-400 font-medium' }, title),
                e('p', { className: 'text-3xl font-bold text-white' }, value)
            );
        };

        const CampaignTable = ({ campaigns, navigate, handleDuplicate }) => {
            const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'ascending' });
            
            const sortedCampaigns = React.useMemo(() => {
                let sortableItems = [...campaigns];
                if (sortConfig !== null) {
                    sortableItems.sort((a, b) => {
                        if (a[sortConfig.key] < b[sortConfig.key]) {
                            return sortConfig.direction === 'ascending' ? -1 : 1;
                        }
                        if (a[sortConfig.key] > b[sortConfig.key]) {
                            return sortConfig.direction === 'ascending' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                return sortableItems;
            }, [campaigns, sortConfig]);

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };
            
            const getSortIndicator = (key) => {
                if (sortConfig.key !== key) return null;
                return sortConfig.direction === 'ascending' ? ' ▲' : ' ▼';
            }

            return e('div', { className: 'overflow-x-auto glass-card' },
                e('table', { className: 'w-full text-right' },
                    e('thead', { className: 'border-b border-slate-700' },
                        e('tr', null,
                            e('th', { className: 'p-4 cursor-pointer text-gray-300 font-medium text-sm', onClick: () => requestSort('name') }, 'اسم الحملة' + getSortIndicator('name')),
                            e('th', { className: 'p-4 cursor-pointer text-gray-300 font-medium text-sm', onClick: () => requestSort('status') }, 'الحالة' + getSortIndicator('status')),
                            e('th', { className: 'p-4 cursor-pointer text-gray-300 font-medium text-sm', onClick: () => requestSort('budget') }, 'الميزانية' + getSortIndicator('budget')),
                            e('th', { className: 'p-4 cursor-pointer text-gray-300 font-medium text-sm', onClick: () => requestSort('spent') }, 'المصروف' + getSortIndicator('spent')),
                            e('th', { className: 'p-4 text-gray-300 font-medium text-sm' }, 'الإجراءات')
                        )
                    ),
                    e('tbody', null, sortedCampaigns.map(campaign =>
                        e('tr', { key: campaign.id, className: 'border-b border-slate-800 hover:bg-slate-700/50 transition-colors' },
                            e('td', { className: 'p-4 text-gray-100 font-medium' }, campaign.name),
                            e('td', { className: 'p-4' }, e('span', { className: `px-2 py-1 rounded-full text-xs font-semibold ${
                                campaign.status === 'نشطة' ? 'bg-green-500/20 text-green-300' :
                                campaign.status === 'منتهية' ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-300'
                            }` }, campaign.status)),
                            e('td', { className: 'p-4' }, `$${Number(campaign.budget || 0).toLocaleString()}`),
                            e('td', { className: 'p-4' }, `$${Number(campaign.spent || 0).toLocaleString()}`),
                            e('td', { className: 'p-4 flex gap-2 no-print' },
                                e('button', { onClick: () => navigate('details', campaign), className: 'text-sky-400 hover:text-sky-300 p-1 font-medium' }, 'تفاصيل'),
                                e('button', { onClick: () => navigate('edit', campaign), className: 'text-amber-400 hover:text-amber-300 p-1 font-medium' }, 'تعديل'),
                                e('button', { onClick: () => handleDuplicate(campaign), className: 'text-emerald-400 hover:text-emerald-300 p-1 font-medium' }, 'تكرار')
                            )
                        )
                    ))
                )
            );
        };
        
        const KanbanBoard = ({ campaigns, navigate, handleDuplicate }) => {
            const columns = {
                'مجدولة': campaigns.filter(c => c.status === 'مجدولة'),
                'نشطة': campaigns.filter(c => c.status === 'نشطة'),
                'منتهية': campaigns.filter(c => c.status === 'منتهية'),
            };

            return e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6' },
                Object.entries(columns).map(([title, items]) =>
                    e('div', { key: title, className: 'bg-slate-800/50 p-4 flex flex-col rounded-xl' },
                        e('h2', { className: 'font-bold text-xl mb-4 border-b-2 border-slate-700 pb-2 text-white' }, `${title} (${items.length})`),
                        e('div', { className: 'flex-grow space-y-4 overflow-y-auto' }, items.map(campaign =>
                            e('div', { key: campaign.id, className: 'bg-slate-700/70 p-4 rounded-lg cursor-pointer transition-transform hover:scale-105', onClick: () => navigate('details', campaign) },
                                e('h3', { className: 'font-semibold text-gray-100' }, campaign.name),
                                e('p', { className: 'text-sm text-gray-400 mt-1' }, `الميزانية: $${Number(campaign.budget || 0).toLocaleString()}`),
                                e('div', { className: 'mt-4 flex gap-2 justify-end no-print' },
                                    e('button', { onClick: (ev) => { ev.stopPropagation(); navigate('edit', campaign); }, className: 'text-amber-400 hover:text-amber-300 p-1 text-xs font-medium' }, 'تعديل'),
                                    e('button', { onClick: (ev) => { ev.stopPropagation(); handleDuplicate(campaign); }, className: 'text-emerald-400 hover:text-emerald-300 p-1 text-xs font-medium' }, 'تكرار')
                                )
                            )
                        ))
                    )
                )
            );
        };
        
        const CampaignForm = ({ campaign = {}, onSave, onCancel, onDelete }) => {
            const [formData, setFormData] = useState({
                id: campaign.id || null,
                name: campaign.name || '',
                status: campaign.status || 'مجدولة',
                startDate: campaign.startDate || '',
                endDate: campaign.endDate || '',
                budget: campaign.budget || '',
                spent: campaign.spent || '',
                results: campaign.results || '',
                tags: campaign.tags || '',
                adCreative: campaign.adCreative || null,
                attachments: campaign.attachments || []
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleFileChange = (e, fieldName) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setFormData(prev => ({ ...prev, [fieldName]: event.target.result }));
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleAttachmentsChange = (e) => {
                 const files = Array.from(e.target.files);
                 files.forEach(file => {
                     const reader = new FileReader();
                     reader.onload = (event) => {
                         setFormData(prev => ({ ...prev, attachments: [...prev.attachments, event.target.result] }));
                     };
                     reader.readAsDataURL(file);
                 });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return e('form', { onSubmit: handleSubmit, className: 'space-y-6' },
                e('h2', { className: 'text-2xl font-bold text-white' }, campaign.id ? 'تعديل الحملة' : 'إضافة حملة جديدة'),
                e(InputField, { name: 'name', label: 'اسم الحملة', value: formData.name, onChange: handleChange, required: true }),
                e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                    e(SelectField, { name: 'status', label: 'الحالة', value: formData.status, onChange: handleChange, options: ['مجدولة', 'نشطة', 'منتهية'] }),
                    e(InputField, { name: 'tags', label: 'الوسوم (مفصولة بفاصلة)', value: formData.tags, onChange: handleChange }),
                    e(InputField, { name: 'startDate', label: 'تاريخ البدء', type: 'date', value: formData.startDate, onChange: handleChange }),
                    e(InputField, { name: 'endDate', label: 'تاريخ الانتهاء', type: 'date', value: formData.endDate, onChange:handleChange }),
                    e(InputField, { name: 'budget', label: 'الميزانية', type: 'number', value: formData.budget, onChange: handleChange }),
                    e(InputField, { name: 'spent', label: 'المصروف الفعلي', type: 'number', value: formData.spent, onChange: handleChange })
                ),
                e('div', {},
                   e('label', { className: 'block mb-2 text-gray-400' }, 'مقاييس الأداء الرئيسية (النتائج)'),
                   e('textarea', { name: 'results', value: formData.results, onChange: handleChange, rows: 4, className: 'w-full p-2 rounded bg-slate-800 border border-slate-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500' })
                ),
                e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6'},
                    e('div', {}, 
                        e('label', { className: 'block mb-2 text-gray-400' }, 'تصميم الإعلان'),
                        e('input', { type: 'file', accept: 'image/*', onChange: (e) => handleFileChange(e, 'adCreative'), className: 'w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100' }),
                        formData.adCreative && e('img', { src: formData.adCreative, className: 'mt-4 max-h-40 rounded-lg' })
                    ),
                     e('div', {}, 
                        e('label', { className: 'block mb-2 text-gray-400' }, 'إرفاق لقطات الشاشة للنتائج'),
                        e('input', { type: 'file', accept: 'image/*', multiple: true, onChange: handleAttachmentsChange, className: 'w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100' }),
                         e('div', { className: 'flex flex-wrap gap-2 mt-4' }, formData.attachments.map((src, index) => e('img', { key: index, src, className: 'max-h-20 rounded-lg' })))
                    )
                ),
                e('div', { className: 'flex justify-end gap-4 mt-8' },
                    campaign.id && e('button', { type: 'button', onClick: () => onDelete(campaign.id), className: 'bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg' }, 'حذف'),
                    e('button', { type: 'button', onClick: onCancel, className: 'bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg' }, 'إلغاء'),
                    e('button', { type: 'submit', className: 'bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg' }, 'حفظ')
                )
            );
        };
        
        const CampaignDetails = ({ campaign, onBack, onEdit, onDelete }) => {
            const handleCopyToClipboard = () => {
                const textToCopy = `
ملخص حملة: ${campaign.name}
============================
الحالة: ${campaign.status}
الفترة: من ${campaign.startDate || 'N/A'} إلى ${campaign.endDate || 'N/A'}
الميزانية: $${Number(campaign.budget || 0).toLocaleString()}
المصروف الفعلي: $${Number(campaign.spent || 0).toLocaleString()}
الوسوم: ${campaign.tags || 'لا يوجد'}
النتائج ومقاييس الأداء:
-------------------------
${campaign.results || 'لم تسجل نتائج'}
بيانات إضافية:
---------------
- تم إرفاق تصميم الإعلان.
- تم إرفاق ${campaign.attachments?.length || 0} لقطة شاشة للنتائج.
                `;
                navigator.clipboard.writeText(textToCopy.trim()).then(() => {
                    alert('تم نسخ بيانات الحملة إلى الحافظة!');
                }).catch(err => {
                    alert('فشل النسخ!');
                    console.error('Copy failed:', err);
                });
            };

            return e('div', { className: 'space-y-6 printable-area'},
                e('div', {className: 'flex justify-between items-start'},
                    e('h2', { className: 'text-3xl font-bold text-white' }, campaign.name),
                     e('div', { className: 'flex gap-2 no-print'}, 
                        e('button', { onClick: onBack, className: 'bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg' }, 'رجوع'),
                        e('button', { onClick: onEdit, className: 'bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg' }, 'تعديل')
                     )
                ),
                e('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4 text-center' },
                    e(DetailCard, { label: 'الحالة', value: campaign.status }),
                    e(DetailCard, { label: 'تاريخ البدء', value: campaign.startDate || 'غير محدد' }),
                    e(DetailCard, { label: 'تاريخ الانتهاء', value: campaign.endDate || 'غير محدد' }),
                    e(DetailCard, { label: 'الوسوم', value: campaign.tags || 'لا يوجد' })
                ),
                 e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                    e('div', { className: 'glass-card p-4' },
                        e('h3', { className: 'font-bold text-lg mb-2 text-gray-200' }, 'الأداء المالي'),
                        e('p', {className:'text-gray-300'}, `الميزانية: $${Number(campaign.budget || 0).toLocaleString()}`),
                        e('p', {className:'text-gray-300'}, `المصروف: $${Number(campaign.spent || 0).toLocaleString()}`)
                    ),
                    e('div', { className: 'glass-card p-4' },
                        e('h3', { className: 'font-bold text-lg mb-2 text-gray-200' }, 'النتائج'),
                        e('p', { className: 'whitespace-pre-wrap text-gray-300' }, campaign.results || 'لا يوجد')
                    )
                 ),
                 e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                    e('div', { className: 'glass-card p-4' },
                        e('h3', { className: 'font-bold text-lg mb-2 text-gray-200' }, 'تصميم الإعلان'),
                        campaign.adCreative 
                            ? e('img', { src: campaign.adCreative, className: 'max-w-full rounded-lg' })
                            : e('p', {className:'text-gray-400'}, 'لم يتم رفع تصميم')
                    ),
                     e('div', { className: 'glass-card p-4' },
                        e('h3', { className: 'font-bold text-lg mb-2 text-gray-200' }, 'مرفقات النتائج'),
                        (campaign.attachments && campaign.attachments.length > 0)
                            ? e('div', { className: 'flex flex-wrap gap-4' }, campaign.attachments.map((src, i) => e('img', { key: i, src, className: 'max-h-40 rounded-lg' })))
                            : e('p', {className:'text-gray-400'}, 'لا توجد مرفقات')
                    )
                 ),
                 e('div', { className: 'flex justify-center gap-4 mt-8 no-print' },
                    e('button', { onClick: handleCopyToClipboard, className: 'bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg' }, 'نسخ للمساعد الذكي'),
                    e('button', { onClick: () => onDelete(campaign.id), className: 'bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg' }, 'حذف الحملة')
                )
            );
        };
        
        const DetailCard = ({ label, value }) => e('div', { className: 'glass-card p-4' },
            e('h4', { className: 'text-sm text-gray-400' }, label),
            e('p', { className: 'font-semibold text-gray-100' }, value)
        );

        // --- Form Helper Components ---
        const InputField = ({ name, label, type = 'text', value, onChange, required = false }) => e('div', {},
            e('label', { htmlFor: name, className: 'block mb-2 text-sm font-medium text-gray-400' }, label),
            e('input', { id: name, name, type, value, onChange, required, className: 'w-full p-2 rounded bg-slate-800 border border-slate-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500' })
        );

        const SelectField = ({ name, label, value, onChange, options }) => e('div', {},
            e('label', { htmlFor: name, className: 'block mb-2 text-sm font-medium text-gray-400' }, label),
            e('select', { id: name, name, value, onChange, className: 'w-full p-2 rounded bg-slate-800 border border-slate-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500' },
                options.map(option => e('option', { key: option, value: option, className:'bg-slate-900 text-white' }, option))
            )
        );

        // --- UI Helper Components ---
        const LoadingSpinner = () => e('div', { className: 'flex justify-center items-center h-64' },
            e('div', { className: 'animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500' })
        );

        const Alert = ({ message, type = 'error' }) => {
            const colors = {
                error: 'bg-red-900/50 text-red-300 border-red-500',
                warning: 'bg-yellow-900/50 text-yellow-300 border-yellow-500'
            };
            return e('div', { className: `p-4 mb-4 border-r-4 rounded ${colors[type]}` }, message);
        };
        
        // --- Mount App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));

    </script>
</body>
</html>
